// Mover coordenadas para o escopo global
const coordenadas = {
    "AM0001F": {
        "lat": -3.08483,
        "lng": -60.072408
    },
    "AM0001R": {
        "lat": -3.102108,
        "lng": -59.943767
    },
    "PAULN08": {
    "lat": -3.745278,
    "lng": -47.494722
    },
    "RRVIV01": {
    "lat": 2.828334,
    "lng": -60.676342
    },
    "RRVIV02": {
    "lat": 2.828611,
    "lng": -60.675833
    },
    "RRVIV03": {
    "lat": 2.82308,
    "lng": -60.673442
    },
    "CXY MQ": {
        "lat": -3.824105,
        "lng": -60.362177
    },
    "MNS 256": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS 260": {
        "lat": 0.31667,
        "lng": -51.15
    },
    "MNS 226": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS 254": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS 261": {
        "lat": -21.988224,
        "lng": -42.360812
    },
    "MNS 262": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS EM": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS AT": {
        "lat": 0.019443,
        "lng": -51.079915
    },
    "MNS NG": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS SOL": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS TMS": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MNS TRN": {
        "lat": 0.076286,
        "lng": -51.07495
    },
    "CRI EC": {
        "lat": -0.001512,
        "lng": -51.063943
    },
    "CVZ LB": {
        "lat": 0.0283736,
        "lng": -51.052618726512705
    },
    "MPU EN": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BBA LV": {
        "lat": 0.1032321,
        "lng": -51.0602817
    },
    "TPU JB": {
        "lat": -3.54155,
        "lng": -59.347395
    },
    "TPU AS": {
        "lat": -3.54155,
        "lng": -59.347395
    },
    "TPU OR": {
        "lat": -3.826336,
        "lng": -60.363916
    },
    "MIC AR": {
        "lat": -3.54155,
        "lng": -59.347395
    },
    "HUT JM": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "HUT PT": {
        "lat": -7.13853,
        "lng": -63.116718
    },
    "HUT SU": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "HUT NL": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "PVO FN": {
        "lat": -8.070252,
        "lng": -63.582978
    },
    "CTM GN": {
        "lat": -3.54155,
        "lng": -59.347395
    },
    "CTM GS": {
        "lat": -3.54155,
        "lng": -59.347395
    },
    "MNS PL": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MPA 314": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MPA 312": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SQA04": {
        "lat": 0.918763,
        "lng": -52.12589
    },
    "MPA GG": {
        "lat": 0.036042,
        "lng": -51.052465
    },
    "MPA 310": {
        "lat": 0.036042,
        "lng": -51.052465
    },
    "MPA SLZ": {
        "lat": 0.078893,
        "lng": -51.058704
    },
    "OPQ CS": {
        "lat": 3.84328,
        "lng": -51.8377
    },
    "MPA PL1": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MPA TP1": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SQA SD": {
        "lat": -0.043097,
        "lng": -51.17555
    },
    "MPA 313": {
        "lat": 0.0605598,
        "lng": -51.0556085
    },
    "ACD BJ": {
        "lat": 0.0434659,
        "lng": -51.061707
    },
    "AGN PFC": {
        "lat": 0.002787,
        "lng": -51.184397
    },
    "BLA CR": {
        "lat": -7.526572,
        "lng": -46.0407602
    },
    "BUT PFC": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "CJRO": {
        "lat": 42.411397,
        "lng": -73.324774
    },
    "CRN CAR": {
        "lat": -7.333939,
        "lng": -47.468868
    },
    "CXUA BR": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "ETO TES": {
        "lat": 3.843438,
        "lng": -51.825514
    },
    "ETO FC": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "GVEL PB": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "ITZ 222": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "ITZ RC": {
        "lat": 0.046451,
        "lng": -51.11763
    },
    "PQIA FC": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "PFN JPE": {
        "lat": -6.34298,
        "lng": -47.39828
    },
    "SLS 201": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SLS 239": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SLS 234": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SLS 208": {
        "lat": -24.202933,
        "lng": -47.129212
    },
    "SLS 236": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SLS 207": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "RIH RIA": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "CDO JL": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SIS KB": {
        "lat": 34.44488,
        "lng": -119.778575
    },
    "STY FO": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BBL FO": {
        "lat": 0.024148,
        "lng": -51.090215
    },
    "ANJ FO": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MIR ME": {
        "lat": -3.56695,
        "lng": -44.577185
    },
    "SLS 237": {
        "lat": 0.094313,
        "lng": -51.100412
    },
    "CXS VO": {
        "lat": 0.918763,
        "lng": -52.12589
    },
    "SLS JPA": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "CHI TED": {
        "lat": -3.72539,
        "lng": -43.369949
    },
    "SMH KB": {
        "lat": -2.516087,
        "lng": -44.159624
    },
    "ITI AVB": {
        "lat": -3.3943147,
        "lng": -44.36
    },
    "ITZ CCE": {
        "lat": -5.5213062,
        "lng": -47.4367112
    },
    "MIBOAQE": {
        "lat": 41.752386,
        "lng": -70.741604
    },
    "PHE GP": {
        "lat": -2.545788,
        "lng": -44.24778
    },
    "NVO DKB": {
        "lat": 46.186168,
        "lng": -59.874562
    },
    "SJE COP": {
        "lat": -21.073688,
        "lng": -49.668794
    },
    "SLS AG": {
        "lat": 6.136674,
        "lng": 1.227386
    },
    "SLS BA": {
        "lat": -7.504638,
        "lng": -46.039125
    },
    "SLS 232": {
        "lat": -7.504638,
        "lng": -46.039125
    },
    "SLS HOL": {
        "lat": -2.493543,
        "lng": -44.271313
    },
    "SLS RDF": {
        "lat": -2.500677,
        "lng": -44.228546
    },
    "SLS RES": {
        "lat": 0.082793,
        "lng": -51.098271
    },
    "ZED GDI": {
        "lat": -0.04785,
        "lng": -51.116829
    },
    "RSI KB": {
        "lat": -2.913374,
        "lng": -44.353306
    },
    "ITZ 212": {
        "lat": -5.477892,
        "lng": -47.455344
    },
    "ITZ 213": {
        "lat": -5.525574,
        "lng": -47.463122
    },
    "ITZ 221": {
        "lat": 0.042417,
        "lng": -51.046987
    },
    "SLS 203": {
        "lat": -2.492631,
        "lng": -44.249947
    },
    "SLS 204": {
        "lat": -2.501217,
        "lng": -44.251436
    },
    "SLS 206": {
        "lat": 21.224551,
        "lng": -100.490742
    },
    "SLS 238": {
        "lat": -2.505367,
        "lng": -44.304522
    },
    "SLS 240": {
        "lat": -2.537327,
        "lng": -44.196359
    },
    "SLS 243": {
        "lat": -10.14605,
        "lng": -36.855665
    },
    "ITMH": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "PSEY RD": {
        "lat": -2.592979,
        "lng": -45.363231
    },
    "ITMG": {
        "lat": -4.448014,
        "lng": -47.527292
    },
    "PSY": {
        "lat": -2.592979,
        "lng": -45.363231
    },
    "ABT 01": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "AIU 200": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "AIU 201": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "AIU 202": {
        "lat": 0.036131,
        "lng": -51.049119
    },
    "AIU 203": {
        "lat": -0.920303,
        "lng": -52.404874
    },
    "AIU 204": {
        "lat": -22.60497,
        "lng": -47.876253
    },
    "AIU 206": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "AIU BR": {
        "lat": -9.330016,
        "lng": -50.324049
    },
    "AIU CAF": {
        "lat": -1.34216,
        "lng": -48.465884
    },
    "ATM AC": {
        "lat": 0.02498,
        "lng": -51.064764
    },
    "BCN 01": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BCN AB": {
        "lat": -1.566439,
        "lng": -48.756785
    },
    "BCN CC": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 214": {
        "lat": 0.100932,
        "lng": -51.089042
    },
    "BLM 215": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 218": {
        "lat": 0.080523,
        "lng": -51.057472
    },
    "BLM 221": {
        "lat": -1.448385,
        "lng": -48.470851
    },
    "BLM 222": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 224": {
        "lat": -23.463084,
        "lng": -46.698487
    },
    "BLM 228": {
        "lat": -0.014839,
        "lng": -51.097318
    },
    "BLM 230": {
        "lat": 0.069632,
        "lng": -51.092038
    },
    "BLM 231": {
        "lat": 0.099487,
        "lng": -51.068424
    },
    "BLM 251": {
        "lat": -0.014839,
        "lng": -51.097318
    },
    "BLM 252": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 253": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 254": {
        "lat": -0.002694,
        "lng": -51.096421
    },
    "BLM 256": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 257": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM 259": {
        "lat": 0.099732,
        "lng": -51.091075
    },
    "BLM AVC": {
        "lat": 0.052808,
        "lng": -51.052199
    },
    "BLM MN": {
        "lat": -1.437406,
        "lng": -48.489649
    },
    "BLM NMA": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM RBA": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM SIG": {
        "lat": -1.458923,
        "lng": -48.495553
    },
    "BLM SZ": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM TPN": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BLM VES": {
        "lat": 0.056772,
        "lng": -51.042901
    },
    "BLM 232": {
        "lat": 0.056772,
        "lng": -51.042901
    },
    "BLM VL": {
        "lat": -1.437081,
        "lng": -48.465351
    },
    "BRV RB": {
        "lat": -1.685139,
        "lng": -50.482306
    },
    "BVS BR": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "CAH RB": {
        "lat": -1.293431,
        "lng": -47.926761
    },
    "CIR SC": {
        "lat": -8.022529,
        "lng": -50.032737
    },
    "CPN CZ": {
        "lat": -1.198065,
        "lng": -47.1793
    },
    "ENTO BR": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "ETN MTDO": {
        "lat": -2.886329,
        "lng": -79.009059
    },
    "IAB FG": {
        "lat": -1.752233,
        "lng": -47.067632
    },
    "ICOR": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "IPPA BR": {
        "lat": -1.297687,
        "lng": -48.177625
    },
    "MBA SVB": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "MBA TM": {
        "lat": -5.332981,
        "lng": -49.08835
    },
    "MOSQ ST": {
        "lat": 19.373322,
        "lng": -99.451114
    },
    "PGN SCP": {
        "lat": 16.451997,
        "lng": 80.609687
    },
    "PTTS RN": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "PUP BU": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "RDO ST": {
        "lat": -8.036383,
        "lng": -50.036028
    },
    "RNP CB": {
        "lat": -4.783238,
        "lng": -48.070317
    },
    "SID BR": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SIP 02": {
        "lat": 0.084637,
        "lng": -51.103367
    },
    "SLPA": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SRM 240": {
        "lat": 0.027942,
        "lng": -51.113633
    },
    "SRM 241": {
        "lat": -7.566604,
        "lng": -44.062829
    },
    "SRM 242": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "TLA FNS": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "TUU CV": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "TUU ER": {
        "lat": -0.055935,
        "lng": -51.175547
    },
    "VNTE": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "SRM SP": {
        "lat": -2.681341,
        "lng": -54.627614
    },
    "CAH  BR": {
        "lat": 51.633934,
        "lng": -99.93174
    },
    "CAH 280": {
        "lat": 51.633934,
        "lng": -99.93174
    },
    "CIOP SRM": {
        "lat": 0.041509,
        "lng": -51.060946
    },
    "BVA AB": {
        "lat": 0.041509,
        "lng": -51.060946
    }


};
async function identificarCidade(lat, lng) {
    try {
        // Primeiro, usar LocationIQ para obter bairro e outros detalhes
        const API_KEY = 'pk.8d008de7d17f1ad2ebfb20d6a4e26e33';
        const responseLocationIQ = await fetch(`https://us1.locationiq.com/v1/reverse?key=${API_KEY}&lat=${lat}&lon=${lng}&format=json&`);
        const dataLocationIQ = await responseLocationIQ.json();
        console.log('Resposta LocationIQ:', dataLocationIQ);

        // Depois, usar Nominatim para obter cidade e estado
        const responseNominatim = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
        const dataNominatim = await responseNominatim.json();
        console.log('Resposta Nominatim:', dataNominatim);

        // Extrair cidade e estado do Nominatim
        const cidade = dataNominatim.address.city || 
                      dataNominatim.address.municipality || 
                      dataNominatim.address.town || 
                      dataNominatim.address.village || '';
        const estado = dataNominatim.address.state || '';

        // Extrair bairro e outros detalhes do LocationIQ
        const bairro = dataLocationIQ.address.suburb || 
                      dataLocationIQ.address.neighbourhood || 
                      dataLocationIQ.address.quarter || 
                      dataLocationIQ.address.residential || 
                      dataLocationIQ.address.district || 
                      dataLocationIQ.address.hamlet || 
                      dataLocationIQ.address.administrative_area_level_4 || 
                      dataLocationIQ.address.administrative_area_level_5 || 
                      '';
        
        const rua = dataLocationIQ.address.road || dataLocationIQ.address.street || dataLocationIQ.address.pedestrian || '';
        const numero = dataLocationIQ.address.house_number || '';
        const enderecoCompleto = [rua, numero, bairro].filter(Boolean).join(', ');
        
        console.log('Dados combinados:', { cidade, estado, bairro, enderecoCompleto });
        
        if (cidade) {
            return {
                cidade: cidade,
                estado: estado,
                bairro: bairro,
                rua: rua,
                numero: numero,
                localidade: `${cidade}/${estado}`,
                enderecoCompleto: enderecoCompleto || `${cidade}/${estado}`
            };
        } else {
            // Fallback usando display_name do Nominatim
            const partes = dataNominatim.display_name.split(',');
            const cidadeAlternativa = partes[0]?.trim() || '';
            const bairroAlternativo = partes[1]?.trim() || '';
            
            return {
                cidade: cidadeAlternativa,
                estado: estado,
                bairro: bairroAlternativo,
                rua: '',
                numero: '',
                localidade: cidadeAlternativa ? `${cidadeAlternativa}/${estado}` : dataNominatim.display_name.split(',')[0],
                enderecoCompleto: dataNominatim.display_name
            };
        }
    } catch (error) {
        console.error('Erro ao identificar localização:', error);
        return {
            cidade: '',
            estado: '',
            bairro: '',
            rua: '',
            numero: '',
            localidade: "Localização não identificada",
            enderecoCompleto: "Localização não identificada"
        };
    }
}

// Função para determinar o CN baseado na localidade
async function determinarCN(localidade) {
    if (!localidade) return '91'; // CN padrão caso não encontre a localidade
    
    // Definir as regiões do Pará por coordenadas
    const regioesPara = {
        '91': { // Região Metropolitana de Belém e nordeste
            minLat: -2.0,
            maxLat: 0.0,
            minLng: -49.0,
            maxLng: -47.0
        },
        '93': { // Oeste do estado
            minLat: -10.0,
            maxLat: -1.0,
            minLng: -58.0,
            maxLng: -52.0
        },
        '94': { // Sudeste do estado
            minLat: -8.0,
            maxLat: -4.0,
            minLng: -52.0,
            maxLng: -48.0
        }
    };

    const cnsPorEstado = {
        'Amazonas': '92',
        'Pará': '91', // Será sobrescrito pela lógica regional
        'Roraima': '95',
        'Amapá': '96',
        'Rondônia': '69',
        'Acre': '68',
        'Tocantins': '63',
        'Maranhão': '98',
        'Piauí': '86',
        'Ceará': '85',
        'Rio Grande do Norte': '84',
        'Paraíba': '83',
        'Pernambuco': '81',
        'Alagoas': '82',
        'Sergipe': '79',
        'Bahia': '71',
        'Minas Gerais': '31',
        'Espírito Santo': '27',
        'Rio de Janeiro': '21',
        'São Paulo': '11',
        'Paraná': '41',
        'Santa Catarina': '47',
        'Rio Grande do Sul': '51',
        'Mato Grosso do Sul': '67',
        'Mato Grosso': '65',
        'Goiás': '62',
        'Distrito Federal': '61'
    };

    try {
        // Se a localidade já contém o estado (formato CIDADE/ESTADO)
        const partes = localidade.split('/');
        if (partes.length > 1) {
            const estado = partes[1].trim();
            const cidade = partes[0].trim();
            
            // Se for Pará, tentar obter as coordenadas da cidade
            if (estado === 'Pará') {
                try {
                    // Usar a API do Nominatim para obter as coordenadas da cidade
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade)},${estado},Brasil&limit=1`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        
                        // Verificar em qual região as coordenadas se encaixam
                        for (const [ddd, regiao] of Object.entries(regioesPara)) {
                            if (lat >= regiao.minLat && lat <= regiao.maxLat &&
                                lng >= regiao.minLng && lng <= regiao.maxLng) {
                                return ddd;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao obter coordenadas da cidade:', error);
                }
                return '91'; // Se não conseguir determinar, retorna o DDD padrão de Belém
            }
            
            return cnsPorEstado[estado] || '91';
        }

        // Se não tiver o estado, tenta buscar usando as coordenadas do site
        const site = document.getElementById('site-search').value.toUpperCase();
        const coords = coordenadas[site];
        
        if (coords) {
            const localizacao = await identificarCidade(coords.lat, coords.lng);
            if (localizacao.estado === 'Pará') {
                // Verificar em qual região as coordenadas se encaixam
                for (const [ddd, regiao] of Object.entries(regioesPara)) {
                    if (coords.lat >= regiao.minLat && coords.lat <= regiao.maxLat &&
                        coords.lng >= regiao.minLng && coords.lng <= regiao.maxLng) {
                        return ddd;
                    }
                }
                return '91'; // Se não encontrar a região, retorna o DDD padrão de Belém
            }
            if (localizacao.estado) {
                return cnsPorEstado[localizacao.estado] || '91';
            }
        }

        return '91'; // CN padrão se não conseguir determinar
    } catch (error) {
        console.error('Erro ao determinar CN:', error);
        return '91';
    }
}

// Função para calcular o SLA baseado no tipo de alarme
function calcularSLA(tipoAlarme, dataHoraAcionamento) {
    if (!dataHoraAcionamento) return 'N/A';
    
    try {
        // Garantir que a data de acionamento seja válida
        const dataAcionamento = new Date(dataHoraAcionamento);
        if (isNaN(dataAcionamento.getTime())) {
            console.error('Data de acionamento inválida:', dataHoraAcionamento);
            return 'N/A';
        }
        
        let horasSLA = 4; // SLA padrão de 4 horas
        
        // Mapeamento dos SLAs por tipo de alarme
        const slaPorAlarme = {
            'AFCA': 4,  // FALHA DE ENERGIA
            'ABAT': 4,  // BATERIA EM DESCARGA
            'AFRET': 24, // FALHA DE RETIFICADOR
            'ADIF': 4,  // FALHA DE FUSÍVEL
            'AQDF': 4,  // FALHA DE QUADRO DE FORÇA
            'ABAL': 24, // FALHA DE BALIZAMENTO
            'AOGMG': 4, // GMG EM OPERAÇÃO
            'ACGMG': 4, // BAIXO NIVEL DE COMBUSTIVEL
            'AFGMG': 4, // FALHA NO GMG
            'ATEMP': 4, // ALTA TEMPERATURA
            'ATRO': 4,  // TROCADOR DE CALOR
            'ARCON': 4  // FALHA DE AR-CONDICIONADO
        };
        
        // Extrair o código do alarme (primeiros 4-5 caracteres)
        const codigoAlarme = tipoAlarme.split(' ')[0];
        horasSLA = slaPorAlarme[codigoAlarme] || 4;
        
        // Calcular a data/hora final do SLA
        const dataFinalSLA = new Date(dataAcionamento.getTime() + (horasSLA * 60 * 60 * 1000));
        
        // Verificar se a data final é válida
        if (isNaN(dataFinalSLA.getTime())) {
            console.error('Erro ao calcular data final do SLA');
            return 'N/A';
        }
        
        // Formatar a data/hora final do SLA
        const dia = String(dataFinalSLA.getDate()).padStart(2, '0');
        const mes = String(dataFinalSLA.getMonth() + 1).padStart(2, '0');
        const ano = dataFinalSLA.getFullYear();
        const hora = String(dataFinalSLA.getHours()).padStart(2, '0');
        const minuto = String(dataFinalSLA.getMinutes()).padStart(2, '0');
        
        return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
    } catch (error) {
        console.error('Erro ao calcular SLA:', error);
        return 'N/A';
    }
}

// Função para formatar data e hora
function formatarDataHora(data, tipo = 'padrao') {
    if (!data) return '';
    
    const dataObj = new Date(data);
    if (isNaN(dataObj.getTime())) return '';
    
    // Formatar apenas hora (HH:mm)
    if (tipo === 'hora') {
        return dataObj.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    // Formatar data e hora (DD/MM/YYYY HH:mm)
    return dataObj.toLocaleString('pt-BR', { 
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Função para calcular a distância entre duas coordenadas usando a fórmula de Haversine
function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em quilômetros
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
              Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distancia = R * c;
    
    return distancia.toFixed(1); // Retorna a distância com 1 casa decimal
}

// Função para gerar o acionamento
async function gerarAcionamento() {
    try {
        const get = id => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Elemento com id '${id}' não encontrado`);
                return '';
            }
            return element.value || '';
        };

        const getSelect = id => {
            const element = document.getElementById(id);
            if (!element || !element.options) {
                console.warn(`Select com id '${id}' não encontrado ou não é um select`);
                return '';
            }
            return element.options[element.selectedIndex]?.text || '';
        };

        // Calcular o SLA diretamente
        const alarmeSelect = document.getElementById('alarme');
        const dataHoraInput = document.getElementById('dataHora');
        let slaFormatado = 'N/A';
        
        if (alarmeSelect && dataHoraInput) {
            const tipoAlarme = alarmeSelect.options[alarmeSelect.selectedIndex].text;
            const dataHoraAcionamento = dataHoraInput.value;
            slaFormatado = calcularSLA(tipoAlarme, dataHoraAcionamento);
        }
        
        // Formatar apenas a hora para acionamento e previsão
        const dataHoraFormatada = formatarDataHora(get('dataHora'), 'hora');
        const previsaoFormatada = formatarDataHora(get('previsao'), 'hora');

        const site = get('site-search') || getSelect('site');
        const localidade = get('localidade');
        const endereco = get('endereco');
        const uc = get('uc');
        
        // Se o campo CN estiver visível, usar o valor digitado, senão determinar automaticamente
        const cnInput = document.getElementById('cn');
        const cn = cnInput.style.display === 'block' ? get('cn') : await determinarCN(localidade);

        let informe = [
            '*INFORMATIVO DE ACIONAMENTO*',
            `*ANALISTA NOC:* ${get('analista')}`,
            `*SUPERVISOR:* ${get('supervisor')}`,
            `*CN:* ${cn}`,
            `*ESTAÇÃO:* ${site}`,
            localidade ? `*LOCALIDADE:* ${localidade}` : '',
            endereco ? `*ENDEREÇO:* ${endereco}` : '',
            uc ? `*UC:* ${uc}` : '',
            `*ALARME:* ${getSelect('alarme')}`,
            `*AMI:* ${get('ami')}`,
            `*INC:* ${get('inc')}`,
            dataHoraFormatada ? `*HORA DO ACIONAMENTO:* ${dataHoraFormatada}` : '',
            previsaoFormatada ? `*PREVISÃO:* ${previsaoFormatada}` : '',
            `*SLA ATÉ:* ${slaFormatado}`,
            `*TÉCNICO ACIONADO:* ${get('tecnico')}`
        ];

        const informeFinal = informe.filter(linha => linha.trim()).join('\n');

        const resultadoElement = document.getElementById('resultado');
        if (resultadoElement) {
            resultadoElement.innerText = informeFinal;
        } else {
            console.error('Elemento de resultado não encontrado');
            alert('Erro ao gerar relatório: elemento de resultado não encontrado');
        }
    } catch (error) {
        console.error('Erro ao gerar relatório:', error);
        alert('Erro ao gerar relatório. Por favor, verifique se todos os campos estão presentes.');
    }
}

// Função para copiar o acionamento gerado
function copiarAcionamento() {
    const resultado = document.getElementById('resultado')?.innerText;
    if (!resultado) {
        alert('Nenhum relatório gerado para copiar!');
        return;
    }
    
    navigator.clipboard.writeText(resultado)
        .then(() => alert('Relatório copiado para a área de transferência!'))
        .catch(err => {
            console.error('Erro ao copiar:', err);
            alert('Erro ao copiar o relatório. Por favor, tente novamente.');
        });
}

// Função para buscar site e filtrar opções
document.getElementById("site-search").addEventListener("input", function() {
    const filter = this.value.toUpperCase();
    const options = document.getElementById("site").options;
    const dropdownContent = document.getElementById('dropdown-content');
    dropdownContent.innerHTML = '';

    if (filter.length >= 1) {
        for (let i = 0; i < options.length; i++) {
            const optionText = options[i].text.toUpperCase();
            if (optionText.includes(filter)) {
                const div = document.createElement('div');
                div.textContent = optionText;
                div.addEventListener('click', async function() {
                    document.getElementById('site-search').value = optionText;
                    document.getElementById('site').selectedIndex = i;
                    dropdownContent.classList.remove('show');
                    await preencherDados(options[i].value);
                });
                dropdownContent.appendChild(div);
            }
        }
        dropdownContent.classList.add('show');
    } else {
        dropdownContent.classList.remove('show');
    }
});

// Função para preencher dados de UC, Endereço e Localidade
async function preencherDados(value) {
    const select = document.getElementById('site');
    const enderecoInput = document.getElementById('endereco');
    const ucInput = document.getElementById('uc');
    const ucLabel = document.querySelector('label[for="uc"]');
    const siteSearch = document.getElementById('site-search');
    const cnInput = document.getElementById('cn');
    const cnLabel = document.querySelector('label[for="cn"]');
    
    // Verifica se o valor digitado corresponde a algum site no banco
    const siteDigitado = siteSearch.value.toUpperCase().trim();
    const coords = coordenadas[siteDigitado];
    
    console.log('Site digitado:', siteDigitado); // Debug
    console.log('Coordenadas encontradas:', coords); // Debug
    
    // Se não encontrou coordenadas OU se o site não está no select, permite edição do endereço e mostra o campo CN
    if (!coords || !select.querySelector(`option[value*="${siteDigitado}"]`)) {
        console.log('Site não encontrado no banco de dados, permitindo edição do endereço e CN'); // Debug
        enderecoInput.readOnly = false;
        enderecoInput.value = '';
        ucInput.value = '';
        ucInput.style.display = 'none';
        ucLabel.style.display = 'none';
        document.getElementById('localidade').value = '';
        document.getElementById('rotasButton').style.display = 'none';
        
        // Mostrar campo CN para preenchimento manual
        cnInput.style.display = 'block';
        cnLabel.style.display = 'block';
        cnInput.readOnly = false;
        cnInput.value = ''; // Limpar o valor do CN
        return;
    }
    
    // Se encontrou coordenadas, continua com o preenchimento normal
    let found = false;
    for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].value === value) {
            const dados = select.options[i].value.split('*');
            ucInput.value = dados[1];
            
            try {
                console.log('Chamando identificarCidade com:', coords.lat, coords.lng); // Debug
                const localizacao = await identificarCidade(coords.lat, coords.lng);
                console.log('Localização identificada:', localizacao); // Debug
                
                // Preencher localidade e endereço (ocultos)
                document.getElementById('localidade').value = localizacao.localidade;
                
                // Se o site estiver no banco, usar o endereço do banco, senão usar o da API
                if (dados[2]) {
                    enderecoInput.value = dados[2];
                    // Adicionar bairro se disponível e não estiver no endereço
                    if (localizacao.bairro && !enderecoInput.value.includes(localizacao.bairro)) {
                        enderecoInput.value = `${enderecoInput.value}, ${localizacao.bairro}`;
                    }
                } else {
                    enderecoInput.value = localizacao.enderecoCompleto;
                }
                
                // Ocultar campo CN pois será preenchido automaticamente
                cnInput.style.display = 'none';
                cnLabel.style.display = 'none';
                
                // Sempre permitir edição do endereço
                enderecoInput.readOnly = false;
                ucInput.style.display = 'block';
                ucLabel.style.display = 'block';
            } catch (error) {
                console.error('Erro ao identificar cidade:', error);
                document.getElementById('localidade').value = '';
                enderecoInput.value = dados[2] || '';
                // Garantir que o endereço seja editável mesmo em caso de erro
                enderecoInput.readOnly = false;
                
                // Em caso de erro, mostrar campo CN para preenchimento manual
                cnInput.style.display = 'block';
                cnLabel.style.display = 'block';
                cnInput.readOnly = false;
                cnInput.value = ''; // Limpar o valor do CN
            }
            
            found = true;
            document.getElementById('rotasButton').style.display = 'block';
            break;
        }
    }
    
    if (!found) {
        console.log('Nenhuma opção correspondente encontrada para o valor:', value); // Debug
        enderecoInput.readOnly = false;
        enderecoInput.value = '';
        ucInput.value = '';
        ucInput.style.display = 'none';
        ucLabel.style.display = 'none';
        document.getElementById('localidade').value = '';
        document.getElementById('rotasButton').style.display = 'none';
        
        // Mostrar campo CN para preenchimento manual
        cnInput.style.display = 'block';
        cnLabel.style.display = 'block';
        cnInput.readOnly = false;
        cnInput.value = ''; // Limpar o valor do CN
    }
}

// Função para abrir o Google Maps com as coordenadas do KML
function abrirGoogleMaps() {
    const site = document.getElementById('site-search').value.toUpperCase();
    const coords = coordenadas[site];

    if (coords) {
        const url = `https://www.google.com/maps?q=${coords.lat},${coords.lng}&z=15`;
        window.open(url, '_blank');
    } else {
        alert('Coordenadas não encontradas para o site selecionado.');
    }
}

document.addEventListener('click', function(event) {
  const dropdownContent = document.getElementById('dropdown-content');
  if (!event.target.matches('#site-search')) {
      dropdownContent.classList.remove('show');
  }
});

// Função para limpar campos UC e Endereço antes de preencher novos dados
function limparCampos() {
  document.getElementById('uc').value = '';
  document.getElementById('endereco').value = '';
}

// Modificar o event listener do campo de busca de site
document.getElementById('site-search').addEventListener('input', async function() {
    limparCampos();
    const filter = this.value.toUpperCase();
    const select = document.getElementById('site');
    const dropdownContent = document.getElementById('dropdown-content');
    dropdownContent.innerHTML = '';

    // Verificar se o valor digitado corresponde exatamente a algum site
    const siteExato = Array.from(select.options).find(option => 
        option.text.toUpperCase() === filter
    );

    if (siteExato) {
        // Se encontrou um site exato, selecionar automaticamente
        select.selectedIndex = Array.from(select.options).indexOf(siteExato);
        await preencherDados(siteExato.value);
        dropdownContent.classList.remove('show');
        return;
    }

    // Se não encontrou site exato, mostrar sugestões
    if (filter.length >= 1) {
        for (let i = 0; i < select.options.length; i++) {
            const optionText = select.options[i].text.toUpperCase();
            if (optionText.includes(filter)) {
                const div = document.createElement('div');
                div.textContent = select.options[i].text;
                div.addEventListener('click', async function() {
                    document.getElementById('site-search').value = select.options[i].text;
                    select.selectedIndex = i;
                    dropdownContent.classList.remove('show');
                    await preencherDados(select.options[i].value);
                });
                dropdownContent.appendChild(div);
            }
        }
        dropdownContent.classList.add('show');
    } else {
        dropdownContent.classList.remove('show');
    }
});

// Adicionar event listener para colar no campo de site
document.getElementById('site-search').addEventListener('paste', async function(e) {
    // Permitir que o evento de colar ocorra normalmente
    setTimeout(async () => {
        const valorColado = this.value.toUpperCase().trim();
        const select = document.getElementById('site');
        
        // Procurar por uma correspondência exata
        const siteExato = Array.from(select.options).find(option => 
            option.text.toUpperCase() === valorColado
        );

        if (siteExato) {
            // Se encontrou um site exato, selecionar automaticamente
            select.selectedIndex = Array.from(select.options).indexOf(siteExato);
            await preencherDados(siteExato.value);
            document.getElementById('dropdown-content').classList.remove('show');
        }
    }, 0);
});

// Funções para mostrar/esconder campos detalhados
function toggleModulo() {
    const moduloDescricao = document.getElementById('moduloDescricao');
    const moduloLabel = document.querySelector('label[for="moduloDescricao"]');
    const moduloVandalizado = document.getElementById('moduloVandalizado');
    if (moduloDescricao && moduloLabel && moduloVandalizado) {
        const display = moduloVandalizado.value === 'SIM' ? 'block' : 'none';
        moduloDescricao.style.display = display;
        moduloLabel.style.display = display;
    }
}

function toggleFibras() {
    const fibrasDetalhes = document.getElementById('fibrasDetalhes');
    const fibrasVandalizadas = document.getElementById('fibrasVandalizadas');
    if (fibrasDetalhes && fibrasVandalizadas) {
        fibrasDetalhes.style.display = fibrasVandalizadas.value === 'SIM' ? 'block' : 'none';
    }
}

function toggleCabos() {
    const cabosDetalhes = document.getElementById('cabosDetalhes');
    const cabosVandalizados = document.getElementById('cabosVandalizados');
    if (cabosDetalhes && cabosVandalizados) {
        cabosDetalhes.style.display = cabosVandalizados.value === 'SIM' ? 'block' : 'none';
    }
}

function toggleBaterias() {
    const bateriasDetalhes = document.getElementById('bateriasDetalhes');
    const bateriasVandalizadas = document.getElementById('bateriasVandalizadas');
    if (bateriasDetalhes && bateriasVandalizadas) {
        bateriasDetalhes.style.display = bateriasVandalizadas.value === 'SIM' ? 'block' : 'none';
    }
}

// Função para inicializar os campos condicionais
function inicializarCamposCondicionais() {
    toggleModulo();
    toggleFibras();
    toggleCabos();
    toggleBaterias();
}

// Adicionar chamada para inicializar campos quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    inicializarCamposCondicionais();
});

// Atualizar o event listener do select site
document.getElementById('site').addEventListener('change', async function() {
    await preencherDados(this.value);
});

// Remover a função compartilharWhatsApp e substituir por toggleUtilitarioDistancia
function toggleUtilitarioDistancia() {
    const utilitario = document.querySelector('.utilitario-distancia');
    const botao = document.querySelector('button[onclick="toggleUtilitarioDistancia()"]');
    
    if (utilitario.style.display === 'none') {
        // Mostrar o utilitário
        utilitario.style.display = 'block';
        botao.innerHTML = '<i class="fa fa-times"></i> Fechar';
        botao.style.backgroundColor = '#dc3545'; // Vermelho para indicar que pode fechar
        
        // Limpar os campos e resultado
        document.getElementById('site-origem').value = '';
        document.getElementById('site-destino').value = '';
        document.getElementById('resultado-distancia').innerHTML = '';
    } else {
        // Ocultar o utilitário
        utilitario.style.display = 'none';
        botao.innerHTML = '<i class="fa fa-calculator"></i> Calcular Distância';
        botao.style.backgroundColor = '#07407e'; // Voltar à cor original
    }
}

// Função para calcular distância entre dois sites específicos
async function calcularDistanciaEntreSites() {
    const siteOrigem = document.getElementById('site-origem').value.toUpperCase().trim();
    const siteDestino = document.getElementById('site-destino').value.toUpperCase().trim();
    const resultadoElement = document.getElementById('resultado-distancia');
    const API_KEY = 'pk.8d008de7d17f1ad2ebfb20d6a4e26e33';
    
    // Verificar se os sites existem no banco de dados
    const coordsOrigem = coordenadas[siteOrigem];
    const coordsDestino = coordenadas[siteDestino];
    
    if (!coordsOrigem || !coordsDestino) {
        let mensagem = 'Sites não encontrados no banco de dados:';
        if (!coordsOrigem) mensagem += `\n- ${siteOrigem}`;
        if (!coordsDestino) mensagem += `\n- ${siteDestino}`;
        resultadoElement.innerHTML = mensagem.replace(/\n/g, '<br>');
        return;
    }

    // Mostrar mensagem de carregamento
    resultadoElement.innerHTML = '<div class="loading">Calculando rota...</div>';
    
    try {
        // Calcular a distância em linha reta primeiro
        const distanciaLinhaReta = calcularDistancia(
            coordsOrigem.lat, coordsOrigem.lng,
            coordsDestino.lat, coordsDestino.lng
        );

        // Tentar obter a rota usando LocationIQ
        const url = `https://us1.locationiq.com/v1/directions/driving/${coordsOrigem.lng},${coordsOrigem.lat};${coordsDestino.lng},${coordsDestino.lat}?key=${API_KEY}&overview=full&geometries=geojson`;
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
            const rota = data.routes[0];
            const distanciaRota = (rota.distance / 1000).toFixed(1); // Converter metros para km
            const tempoEstimado = Math.round(rota.duration / 60); // Converter segundos para minutos
            
            // Formatar o resultado
            const resultado = `
                <strong>Distância entre sites:</strong><br>
                De: ${siteOrigem} (${coordsOrigem.lat.toFixed(6)}, ${coordsOrigem.lng.toFixed(6)})<br>
                Para: ${siteDestino} (${coordsDestino.lat.toFixed(6)}, ${coordsDestino.lng.toFixed(6)})<br>
                <strong>Distância da rota: ${distanciaRota} km</strong><br>
                <em>Distância em linha reta: ${distanciaLinhaReta} km</em><br>
                <strong>Tempo estimado: ${tempoEstimado} minutos</strong><br>
                <button onclick="abrirRotaNoMaps('${siteOrigem}', '${siteDestino}')" class="btn-rota">
                    <i class="fa fa-map-marker"></i> Abrir rota no mapa
                </button>
            `;
            
            resultadoElement.innerHTML = resultado;
        } else {
            throw new Error('Não foi possível calcular a rota');
        }
    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        // Em caso de erro, mostrar apenas a distância em linha reta
        resultadoElement.innerHTML = `
            <div class="error">
                Não foi possível calcular a rota completa. Mostrando distância em linha reta...<br>
                <strong>Distância em linha reta:</strong><br>
                De: ${siteOrigem} (${coordsOrigem.lat.toFixed(6)}, ${coordsOrigem.lng.toFixed(6)})<br>
                Para: ${siteDestino} (${coordsDestino.lat.toFixed(6)}, ${coordsDestino.lng.toFixed(6)})<br>
                <strong>Distância: ${calcularDistancia(
                    coordsOrigem.lat, coordsOrigem.lng,
                    coordsDestino.lat, coordsDestino.lng
                )} km</strong>
            </div>
        `;
    }
}

// Função para abrir a rota no mapa (usando OpenStreetMap)
function abrirRotaNoMaps(siteOrigem, siteDestino) {
    const coordsOrigem = coordenadas[siteOrigem];
    const coordsDestino = coordenadas[siteDestino];
    
    if (coordsOrigem && coordsDestino) {
        // Usar OpenStreetMap para mostrar a rota
        const url = `https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route=${coordsOrigem.lat},${coordsOrigem.lng};${coordsDestino.lat},${coordsDestino.lng}`;
        window.open(url, '_blank');
    }
}

// Adicionar autocomplete para os campos de site
document.addEventListener('DOMContentLoaded', function() {
    // Configurar autocomplete para site de origem
    const siteOrigemInput = document.getElementById('site-origem');
    const dropdownOrigem = document.getElementById('dropdown-origem');
    
    siteOrigemInput.addEventListener('input', function() {
        const filter = this.value.toUpperCase();
        dropdownOrigem.innerHTML = '';
        
        if (filter.length >= 1) {
            for (const [site, coords] of Object.entries(coordenadas)) {
                if (site.includes(filter)) {
                    const div = document.createElement('div');
                    div.textContent = site;
                    div.addEventListener('click', function() {
                        siteOrigemInput.value = site;
                        dropdownOrigem.classList.remove('show');
                    });
                    dropdownOrigem.appendChild(div);
                }
            }
            dropdownOrigem.classList.add('show');
        } else {
            dropdownOrigem.classList.remove('show');
        }
    });
    
    // Configurar autocomplete para site de destino
    const siteDestinoInput = document.getElementById('site-destino');
    const dropdownDestino = document.getElementById('dropdown-destino');
    
    siteDestinoInput.addEventListener('input', function() {
        const filter = this.value.toUpperCase();
        dropdownDestino.innerHTML = '';
        
        if (filter.length >= 1) {
            for (const [site, coords] of Object.entries(coordenadas)) {
                if (site.includes(filter)) {
                    const div = document.createElement('div');
                    div.textContent = site;
                    div.addEventListener('click', function() {
                        siteDestinoInput.value = site;
                        dropdownDestino.classList.remove('show');
                    });
                    dropdownDestino.appendChild(div);
                }
            }
            dropdownDestino.classList.add('show');
        } else {
            dropdownDestino.classList.remove('show');
        }
    });
    
    // Fechar dropdowns quando clicar fora
    document.addEventListener('click', function(event) {
        if (!event.target.matches('#site-origem')) {
            dropdownOrigem.classList.remove('show');
        }
        if (!event.target.matches('#site-destino')) {
            dropdownDestino.classList.remove('show');
        }
    });
});


